const voice = document.querySelector(".mic1"); //Connect with mic
let phone_number = [];
var transcript;
let contact = "";
var flow = "";
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;
const recorder = new SpeechRecognition();
voice.addEventListener("click", () => {
  recorder.start();
});
recorder.onstart = () => {
  console.log("Voice activated");
  //   bars.style.visibility = "visible";
  //   mic.style.visibility = "hidden";
};
recorder.onresult = (event) => {
  const resultIndex = event.resultIndex;
  transcript = event.results[resultIndex][0].transcript;

  getBotResponse(transcript);

  //   bars.style.visibility = "hidden";
  //   mic.style.visibility = "visible";
  return transcript;
};
recorder.onerror = function (event) {
  //   bars.style.visibility = "hidden";
  //   mic.style.visibility = "visible";
  console.log("Error occurred in recognition: " + event.error);
};

$("#user_input").keyup(function (e) {
  // detects the enter key to send the query to bot server
  if (e.which == 13) {
    var rawText = $("#user_input").val();
    var transcript = $("#user_input").val();
    getBotResponse(transcript);
  }
});

function getBotResponse(transcript) {
  $("#user_input").val("");
  $.get("/get", { user_query: $.trim(transcript) }).done(function (
    bot_response_list
  ) {
    $.each(bot_response_list, function (index, response) {
      // bot response is a list of strings so each of them are placed one by one
      if (response.trim()) {
        console.log(response);
        type = response;
        recog(transcript);
      }
    });
  });
}

function recog(transcript) {
  console.log("recog");
  console.log(type);
  console.log(transcript);
  if (type == "room_book") {
    num.style.visibility = "visible";
    num.play();
    num_content.style.visibility = "visible";
    console.log("number video");
    // setiing value of temporary variable to pass in js only
    flow = "booking";
  } else if (type == "banquet_book") {
    num.style.visibility = "visible";
    num.play();
    num_content.style.visibility = "visible";
    console.log("number video");
    flow = "banquet";
  } else if (type == "number") {
    phone_number = transcript.match(/\d/g);
    console.log(phone_number);
    // if (phone_number.length == 10) {
    var o = phone_number.toString();
    contact = o.replaceAll(/,/g, "");
    console.log(contact);
    // store name of user
    names.style.visibility = "visible";
    names.play();
    name_content.style.visibility = "visible";
    console.log("name video");
  } else if (type == "name") {
    close();
    // Store name
    var name;
    // Play Date
    dates.style.visibility = "visible";
    dates.play();
    date_content.style.visibility = "visible";
    console.log("Date video");
  } else if (type.includes("date")) {
    close();
    // fetch adults
    if (flow == "booking") {
      adults.style.visibility = "visible";
      adults.play();
      adults_content.style.visibility = "visible";
      console.log("Adults video");
    } else if (flow == "banquet") {
      banquet.style.visibility = "visible";
      banquet.play();
      banquet_content.style.visibility = "visible";
      console.log("Banquet video");
    } else if (flow == "conference") {
      conference.style.visibility = "visible";
      conference.play();
      conference_content.style.visibility = "visible";
      console.log("Conference video");
    }
  } else if (type == "adult") {
    close();
    // Select room
    rooms.style.visibility = "visible";
    rooms.play();
    rooms_content.style.visibility = "visible";
    console.log("rooms video");
  } else if (type == "room_see") {
    close();
    if (flow == "booking") {
      // IF flows is from booking
      payment.style.visibility = "visible";
      payment.play();
      payment_content.style.visibility = "visible";
      console.log("payment video");
    } else {
      // If user directly say
      rooms.style.visibility = "visible";
      rooms.play();
      rooms_content.style.visibility = "visible";
      console.log("rooms video");
    }
  } else if (type == "payment") {
  } else if (type == "banquet_see") {
    banquets.style.visibility = "visible";
    banquets.play();
    banquet_content.style.visibility = "visible";
    console.log("banquet video");
  } else if (type == "conference") {
    conferences.style.visibility = "visible";
    conferences.play();
    conference_content.style.visibility = "visible";
    console.log("conference video");
  } else if (type == "restro_see") {
    rest.style.visibility = "visible";
    rest.play();
    rest_content.style.visibility = "visible";
    console.log("rest video");
  } else if (type == "gym_see") {
    gyms.style.visibility = "visible";
    gyms.play();
    gym_content.style.visibility = "visible";
    console.log("gym video");
  } else if (type == "spa_see") {
    spas.style.visibility = "visible";
    spas.play();
    spa_content.style.visibility = "visible";
    console.log("spa video");
  } else if (type == "gallery") {
    gallerys.style.visibility = "visible";
    gallerys.play();
    gallerys_content.style.visibility = "visible";
  } else if (type == "near") {
    local.style.visibility = "visible";
    local.play();
    local_content.style.visibility = "visible";
  } else if (type == "hidden") {
    hidden.style.visibility = "visible";
    hidden.play();
    hidden_content.style.visibility = "visible";
  } else if (type == "activity") {
    activity.style.visibility = "visible";
    activity.play();
    activity_content.style.visibility = "visible";
  } else if (type == "complaint") {
    complaint.style.visibility = "visible";
    complaint.play();
    complaint_content.style.visibility = "visible";
  } else if (type == "refund") {
    refund.style.visibility = "visible";
    refund.play();
    refund_content.style.visibility = "visible";
  } else if (type == "refund_status") {
    refund_status.style.visibility = "visible";
    refund_status.play();
    refundstatus_content.style.visibility = "visible";
  } else if (type == "review") {
    review.style.visibility = "visible";
    review.play();
    review_content.style.visibility = "visible";
  }
}

// Closing content
function close() {
  video();
  name_content.style.visibility = "hidden";
  date_content.style.visibility = "hidden";
  num_content.style.visibility = "hidden";
  adults_content.style.visibility = "hidden";
  rooms_content.style.visibility = "hidden";
  payment_content.style.visibility = "hidden";
  banquets_contents.style.visibility = "hidden";
  conferences_contents.style.visibility = "hidden";
  gyms_contents.style.visibility = "hidden";
  spas_contents.style.visibility = "hidden";
  local_content.style.visibility = "hidden";
  hidden_content.style.visibility = "hidden";
  activity_content.style.visibility = "hidden";
  complaint_content.style.visibility = "hidden";
  refund_content.style.visibility = "hidden";
  refundstatus_content.style.visibility = "hidden";
  review_content.style.visibility = "hidden";
}

// closing videos

function video() {
  idle.style.visibility = "visible";
  idle.play();

  names.style.visibility = "hidden";
  dates.style.visibility = "hidden";
  num.style.visibility = "hidden";
  adults.style.visibility = "hidden";
  rooms.style.visibility = "hidden";
  payment.style.visibility = "hidden";
  banquets.style.visibility = "hidden";
  conferences.style.visibility = "hidden";
  gyms.style.visibility = "hidden";
  spas.style.visibility = "hidden";
  gallerys.style.visibility = "hidden";
  local.style.visibility = "hidden";
  hidden.style.visibility = "hidden";
  activity.style.visibility = "hidden";
  complaint.style.visibility = "hidden";
  refund.style.visibility = "hidden";
  refund_status.style.visibility = "hidden";
  review.style.visibility = "hidden";

  names.pause();
  dates.pause();
  num.pause();
  adults.pause();
  rooms.pause();
  payment.pause();
  banquets.pause();
  conferences.pause();
  gyms.pause();
  spas.pause();
  gallerys.pause();
  local.pause();
  hidden.pause();
  activity.pause();
  complaint.pause();
  refund.pause();
  refund_status.pause();
  review.pause();
}

// ONENDED
document.getElementById("names").addEventListener("ended", myHandler, false);
document.getElementById("dates").addEventListener("ended", myHandler, false);
document.getElementById("adults").addEventListener("ended", myHandler, false);
document.getElementById("rooms").addEventListener("ended", myHandler, false);
document.getElementById("payment").addEventListener("ended", myHandler, false);
document.getElementById("num").addEventListener("ended", myHandler, false);
document.getElementById("banquets").addEventListener("ended", myHandler, false);
document
  .getElementById("conferences")
  .addEventListener("ended", myHandler, false);
document.getElementById("gyms").addEventListener("ended", myHandler, false);
document.getElementById("spas").addEventListener("ended", myHandler, false);

function myHandler(e) {
  video();
}

// windows on loading
window.onload = function () {};
